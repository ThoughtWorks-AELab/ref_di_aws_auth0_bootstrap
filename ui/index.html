<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SSO</title>
    <style>
        #token {
            width: 500px;
            height: 250px;
        }
    </style>
    <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"
    ></script>
    <script>

        $(document).ready(function(){
            $.get("/env").then(function(env){
                hashObject = getHashObject();
                enableLoginButton(env);
                if (hashObject['access_token']) {
                    getAWSToken(hashObject['id_token'], env.client_id, env.host)
                        .then(function(token) {
                            saveToken(token);
                        });
                }
            });
        });

        function saveToken(token) {
            $("#token").text(JSON.stringify(token));
        }

        function getAWSToken (token, clientId, domain) {
            var message = {
              "client_id":   clientId,
              "grant_type":  "urn:ietf:params:oauth:grant-type:jwt-bearer",
              "id_token":    token,
              "target":      clientId,
              "api_type":    "aws"
            }

            return $.post("https://$domain/delegation".replace("$domain", domain), data=message)
                .then(function(data){
                    return data;
                });

        }

        function enableLoginButton(env) {
            $("#login-link").click(function() {
                redirectURI = encodeURIComponent("http://localhost:8000")
                state = "TODO"
                window.location = "https://$HOST/authorize?scope=openid%20name%20email%20nickname&response_type=token&state=$STATE&sso=true&connection=$CONNECTION&client_id=$CLIENT_ID&redirect_uri=$REDIRECT_URI"
                    .replace("$HOST", env.host)
                    .replace("$STATE", "TODO")
                    .replace("$CONNECTION", env.connection)
                    .replace("$CLIENT_ID", env.client_id)
                    .replace("$REDIRECT_URI", redirectURI)
            });
        }

        function getHashObject() {
            var hash = window.location.hash;
            hash = hash.length > 0 ? hash.substring(1) : ""

            return hash.split("&").reduce(function(prev, curr, i, arr) {
                var p = curr.split("=");
                prev[decodeURIComponent(p[0])] = decodeURIComponent(p[1]);
                return prev;
            }, {});
        }

    </script>
</head>
<body>
    <div>
       <a href="#" id="login-link">Login</a>
    </div>
    <div>
        <textarea id="token">

        </textarea>
    </div>
</body>
</html>
